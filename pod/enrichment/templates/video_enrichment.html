<!-- HTML for enrichment main page. -->
{% extends 'base.html' %}
{% load i18n %}
{% load staticfiles %}
{% block page_title %}{% trans 'Enrichment of the video' %} "{{video.title}}" {% endblock page_title %}
{% block page_extra_head %}
	<!-- stylesheets -->
	<link href="{% static 'video-js-6.8.0/video-js.min.css' %}" rel="stylesheet"/>
	<link href="{% static 'css/quality-selector.css' %}" rel="stylesheet"/>
	<link rel="stylesheet" href="{% static 'css/enrichment.css' %}"/>
	<!-- javascripts -->
	<script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'video-js-6.8.0/ie8/videojs-ie8.min.js' %}"></script>
	<script src="{% static 'video-js-6.8.0/video.min.js' %}"></script>
	<script src="{% static 'js/silvermine-videojs-quality-selector.min.js' %}"></script>
	<script src="{% static 'js/videojs-http-streaming.min.js' %}"></script>
	<script src="{% static 'js/videojs-contrib-quality-levels.min.js' %}"></script>
	<script src="{% static 'js/videojs-hls-quality-selector.min.js' %}"></script>
	<script src="{% static 'video-js-6.8.0/lang/fr.js' %}"></script>
	<script src="{% static 'video-js-6.8.0/lang/nl.js' %}"></script>
    <script src="{% static 'js/enrichment.js' %}"></script>
    <script>
    	var num = 0,
	    name = '';
		/*** For the form ***/;
		var video_duration = {{video.duration}};
		/*** For the Cancel button ***/
		$(document).on("reset", "#page-video form", function (e) {
		    $("span#form_enrich").html("");
		    $('form#form_new').show();
		    $('form').show();
		    $("table tr").removeClass("info");
		    manageResize();
		});
	</script>
	{% if video.enrichment_set.all %}
		<link rel="stylesheet" href="{% static 'css/videojs-slides.css' %}"/>
		<script src="{% static 'js/videojs-slides.js' %}"></script>
	{% endif %}
{% endblock page_extra_head %}
{% block content %}
	<article id="page-video" class="container" role="main" itemprop="video" itemscope itemtype="http://schema.org/VideoObject">
		<main role="main" class="mt-3">
			<nav aria-label="breadcrumb" class="breadcrumb d-flex justify-content-between p-0">
				<ol class="breadcrumb p-1 p1-4 mb-0">
					{% block breadcrumbs %}
						{{block.super}}
						<li class="active">&nbsp;{% trans 'Enrich video' %} "{{video.title}}"</li>
					{% endblock breadcrumbs %}
				</ol>
				<div class="p-0">
					<a class="btn btn-primary btn-sm" data-toggle="collapse" href="#collapseAside" role="button" aria-expanded="false" aria-controls="collapseAside">
						<svg height="32" class="octicon octicon-grabber" viewBox="0 0 8 16" version="1.1" width="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 4v1H0V4h8zM0 8h8V7H0v1zm0 3h8v-1H0v1z"></path></svg>
					</a>
				</div>
			</nav>
			<span id="enrich_player">
				<video id="podvideoplayer" class="video-js vjs-default-skin vjs-16-9 vjs-big-play-centered" controls preload="auto" height="360" poster="{{video.get_thumbnail_url}}" data-setup='{}'>
					<p class="vjs-no-js">
						To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
					</p>
					{% if video.enrichment_set.all %}
						<track kind="metadata" src="{{video.get_enrichments_file}}">
					{% endif %}
				</video>
			</span>
			<hr/>
			<div class="row" id="info_video">
				<div class="col-sm-9">
					<div id="list_enrich">
						{% include 'enrichment/list_enrichment.html' %}
					</div>
					<div id="form_enrich">
						{% if form_enrichment %}
							{% include 'enrichment/form_enrichment.html' with form_enrichment=form_enrichment %}
						{% endif %}
					</div>
					{% if not form_enrichment %}
						<form id="form_new" class="get_form" action="{% url 'video_enrichment' slug=video.slug %}" method="POST">
							{% csrf_token %}
							<input type="hidden" name="action" value="new"/>
							<input type="submit" id="add_new_enrichment" value="{% trans 'Add a new enrichment' %}" class="btn btn-info"/>
						</form>
					{% endif %}
					<small class="video_back">
				      <a href="{% url 'video_edit' slug=video.slug %}">
				        <button class="btn btn-default" title="Go to video edit">{% trans 'Back to video edit' %}</button>
				      </a>
				    </small>
				</div>
				<aside class="collapse col-12 col-md-3 order-1 order-md-12 mb-3" id="collapseAside">
					<div class="card info-card">
						<div class="card-body">
							<h4 class="card-title">{% trans 'Informations' %}</h4>
							<p>{% trans 'The title field is required and must contains from 2 to 100 characters.' %}</p>
							<p>{% trans 'The fields "Start" and "End" must contain an indication value in seconds. Start playback of the video, pause the video and click on "Get time from the player" to fill in the field untitled "Start". Then do the same to fill in the field untitled "End".' %}</p>
							<p>{% trans 'You cannot overlap enrichments.' %}</p>
							<p>{% trans 'You must save your enrichments to view the result.' %}</p>
						</div>
					</div>
				</aside>
			</div>
		</main>
	</article>
{% endblock content %}
{% block more_script %}
<script>
	var options = {
	  notSupportedMessage: "Please use different browser (Mozzila Firefox, Google Chrome, Safari, Microsoft Edge)",
	  language: "fr", //en or nl
	  fluid: true, 
	  playbackRates: [0.5, 1, 1.5, 2]
	}
	var player = videojs('podvideoplayer', options, function(){});

	{% if video.is_video %}
	  /** get all mp4 format **/
	  var mp4_sources = {{video.get_video_mp4_json|safe}};
	  
	  {% if video.get_playlist_master %}
	    var srcOptions = {
	      src: '{{video.get_playlist_master.source_file.url}}',
	      type: '{{video.get_playlist_master.encoding_format}}',
	    };
	    player.on('loadedmetadata', function() {
	      console.log('LOADEDMETADATA');
	      var qualityLevels = this.qualityLevels();
	    });
	    //Add source to player
	    player.src(srcOptions);
	    //add quality selector to player
	    player.hlsQualitySelector();
	    player.on("error", function(e){
	      e.stopImmediatePropagation();
	      var error = player.error();
	      if(error.code == 3) {
	        //console.log('error!', error.code, error.type , error.message);
	        if(player.src().indexOf("m3u8")!=-1){
	          //alert("change source to mp4");
	          player.src(mp4_sources);
	          player.controlBar.addChild('QualitySelector');
	          player.play();
	        }
	      }
	    });
	  {% else %}
	    player.src(mp4_sources);
	    player.controlBar.addChild('QualitySelector');
	  {% endif %}
	{% else %}
	  {% if video.get_video_m4a %}
	    var srcOptions = {
	      src: '{{video.get_video_m4a.source_file.url}}',
	      type: '{{video.get_video_m4a.encoding_format}}',
	    };
	    //Add source to player
	    player.src(srcOptions);
	  {% endif %}
	{% endif %}
	{% if video.enrichment_set.all %}
	  	player.ready(function() {
	  		var tracks = player.textTracks();
	  		var metadataTrack;
	  		for (let i = 0; i < tracks.length; i++) {
	  			var track = tracks[i];
	  			if (track.kind === 'metadata' && track.label === '') {
	  				metadataTrack = track;
	  			}
	  		}
	  		player.on('loadedmetadata', function() {
	  			var slide = [];
	  			for (let i = 0; i < metadataTrack.cues.length; i++) {
			  		data = JSON.parse(metadataTrack.cues[i].text);
			  		slide.push({
			  			title: data.title,
			  			url: data.url,
			  			type: data.type,
			  			start: metadataTrack.cues[i].startTime,
			  			end: metadataTrack.cues[i].endTime
			  		});
			  	}
			  	player.slides(slide);
	  		});
			$('.vjs-big-play-button').css('z-index', 2)
			$('.vjs-control-bar').css('z-index', 3);
		});
	{% endif %}
</script>
{% endblock more_script %}