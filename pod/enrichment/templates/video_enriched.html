<!-- HTML for enrichment view video page. -->
{% extends 'base.html' %}
{% load i18n %}
{% load staticfiles %}
{% load tagging_tags %}

{% block page_extra_head %}
	<link href="{% static 'video-js-6.8.0/video-js.min.css' %}" rel="stylesheet">
	<link href="{% static 'css/quality-selector.css' %}" rel="stylesheet">
	<link rel="stylesheet" href="{% static 'css/videojs-slides.css' %}"/>

	<script src="{% static 'video-js-6.8.0/ie8/videojs-ie8.min.js' %}"></script>
	<script src="{% static 'video-js-6.8.0/video.min.js' %}"></script>
	<script src="{% static 'js/silvermine-videojs-quality-selector.min.js' %}"></script>
	<script src="{% static 'js/videojs-http-streaming.min.js' %}"></script>
	<script src="{% static 'js/videojs-contrib-quality-levels.min.js' %}"></script>
	<script src="{% static 'js/videojs-hls-quality-selector.min.js' %}"></script>
	<script src="{% static 'video-js-6.8.0/lang/fr.js' %}"></script>
	<script src="{% static 'video-js-6.8.0/lang/nl.js' %}"></script>
	<script src="{% static 'js/videojs-slides.js' %}"></script>
	<style>
		.scrollspy-video {
		    position: relative;
		    height: 200px;
		    margin-top: .5rem;
		    overflow: auto;
		}
		{{channel.style}}
		{% if channel.color %}
			body {
			  background-color: {{channel.color}};
			}
		{%endif%}
	</style>
{% endblock page_extra_head %}

{% block breadcrumbs %}{{ block.super }} 
	<li class="breadcrumb-item"><a href="{% url "videos"%}">{% trans 'Videos' %}</a><li class="breadcrumb-item active" aria-current="page">{{video.title}} - Enriched</li>
{% endblock %}

{% block page_title %}{{video.title}} - Enriched{% endblock %}

{% block page_content %}
	<meta itemprop="duration" content="{{ video.duration }}" />
	<meta itemprop="thumbnailUrl" content="{{ video.thumbnail.url }}" />
	<meta itemprop="contentURL" content="{% if request.is_secure %}https{% else %}http{% endif %}://{{ request.META.HTTP_HOST }}{% url 'video' slug=video.slug %}" />
	<meta itemprop="embedURL" content="{% if request.is_secure %}https{% else %}http{% endif %}://{{ request.META.HTTP_HOST }}{% url 'video' slug=video.slug %}?is_iframe=true&amp;size=360" />

	{% if form %}
	<p>{% trans 'This video is protected by password, please fill in and click send.' %}</p>
	<form method="post" action="{{ request.get_full_path }}" id="video_password_form" class='needs-validation' novalidate>
	    {% csrf_token %}
	    <div class="list-group">
	    <fieldset>
	        <legend>{% trans 'Password required' %}</legend>
	        {% if form.errors %}
	        <p class="text-danger">{% trans "One or more errors have been found in the form." %}</p>
	        {% endif %}
	        {% for field_hidden in form.hidden_fields %}
	            {{field_hidden}}
	            {% endfor %}
	            {% for field in form.visible_fields %}
	            {% spaceless %}
	            <div class="list-group-item">
	            <div class="form-group {% if field.field.required %}form-group-required {%endif%}" >
	                {{ field.errors }}
	                <label for="{{ field.id_for_label }}">{{ field.label }}</label> 
	                {{ field }}
	                {% if field.help_text %}
	                <small id="{{field.id_for_label}}Help" class="form-text text-muted">{{ field.help_text|safe }}</small>
	                {% endif %}
	                {% if field.field.required %}<div class="invalid-feedback">{% trans "Please provide a valid value for this field" %}.</div>{%endif%}
	            </div>
	            </div>
	            {% endspaceless %}
	            {% endfor %}
	        <div class="text-center">
	            <button type="submit" class="btn btn-success">{% trans "Send" %}</button>
	        </div>
	    </fieldset>
	    </div>
	</form>
	<p>
	  {% trans 'If you do not have the password for this content, please' %} <a href="#?owner={{video.owner.id}}&video={{video.id}}">{% trans 'contact its owner' %}</a>.
	</p>

	{% else %}
	<video id="podvideoplayer" class="video-js vjs-default-skin vjs-16-9 vjs-big-play-centered" controls preload="auto" height="360"
	poster="{{video.get_thumbnail_url}}" data-setup='{}'>
	  <p class="vjs-no-js">
	    To view this video please enable JavaScript, and consider upgrading to a web browser that
	    <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
	  </p>
	  <source src="https://d2zihajmogu5jn.cloudfront.net/bipbop-advanced/bipbop_16x9_variant.m3u8" type="application/x-mpegURL">
	  <track kind="metadata" src="{{video.get_enrichments_file}}">
	</video>
	<nav id="navbar-example2" class="navbar navbar-light bg-light">
  		<a class="navbar-brand" href="#">({% trans 'Enriched' %}) {{video.title}} {% if video.date_evt %}<small>[{{ video.date_evt }}]</small>{% endif %}</a>
		<small class="video_back">
			<a href="{% url 'video' slug=video.slug %}">
				<button class="btn btn-default" title="Back to original video">{% trans 'Back to original' %}</button>
			</a>
		</small>
	</nav>
	{% endif %}
{% endblock page_content %}

{% block page_aside %}
    <div class="card card-body">
    	<h5 class="card-title">
    		<svg height="32" class="octicon octicon-pencil" viewBox="0 0 14 16" version="1.1" width="28" aria-hidden="true"><path fill-rule="evenodd" d="M0 11.592v3h3l8-8-3-3-8 8zm3 2H1v-2h1v1h1v1zm10.3-9.3l-1.3 1.3-3-3 1.3-1.3a.996.996 0 0 1 1.41 0l1.59 1.59c.39.39.39 1.02 0 1.41z"></path></svg>
    		{% trans "take Note"%}
    	</h5>
    	<div class="card-text">
      		<p>Prenez des notes</p>
      		<div id="info"></div>
    	</div>
    </div>
    <div class="card card-body">
    	<h5 class="card-title">
    		{% trans 'Informations' %}
    	</h5>
    	<div class="card-text">
    		<p>{% trans 'To help you, the different types of enrichments have specific colors' %}:</p>
    		<p>
    			<ul>
    				<li><font color="purple">{% trans 'Image' %}</font></li>
    				<li><font color="yellow">{% trans 'Document' %}</font></li>
    				<li><font color="blue">{% trans 'Richtext' %}</font></li>
    				<li><font color="red">{% trans 'Weblink' %}</font></li>
    				<li><font color="green">{% trans 'Embed' %}</font></li>
    			</ul>
    		</p>
    		<p>{% trans 'There are visible on the video playback bar.' %}</p>
    	</div>
    </div>
{% endblock page_aside %}

{% block more_script %}
	{% if form %}
		<script>
		var showalert = function(message,alerttype) {
		    $('body').append('<div id="formalertdiv" class="alert ' +  alerttype + ' alert-dismissible fade show"  role="alert">'+message+'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
		    setTimeout(function() { $("#formalertdiv").remove(); }, 5000);
		};
		// Example starter JavaScript for disabling form submissions if there are invalid fields
		(function() {
		  'use strict';
		  window.addEventListener('load', function() {
		    // Fetch all the forms we want to apply custom Bootstrap validation styles to
		    var forms = document.getElementsByClassName('needs-validation');
		    // Loop over them and prevent submission
		    var validation = Array.prototype.filter.call(forms, function(form) {
		      form.addEventListener('submit', function(event) {
		        if (form.checkValidity() === false) {
		          window.scrollTo($("#video_password_form").scrollTop(), 0); 
		          showalert("{% trans "Errors appear in the form, please correct it"%}","alert-danger");
		          event.preventDefault();
		          event.stopPropagation();
		        }
		        form.classList.add('was-validated');
		      }, false);
		    });
		  }, false);
		})();
		</script>
	{% else %}
		<script>
		var options = {
		  notSupportedMessage: "Please use different browser (Mozzila Firefox, Google Chrome, Safari, Microsoft Edge)",
		  language: "fr", //en or nl
		  fluid: true, 
		  playbackRates: [0.5, 1, 1.5, 2]
		}
		var player = videojs('podvideoplayer', options, function(){});

		{% if video.is_video %}
		  /** get all mp4 format **/
		  var mp4_sources = {{video.get_video_mp4_json|safe}};
		  
		  {% if video.get_playlist_master %}
		    var srcOptions = {
		      src: '{{video.get_playlist_master.source_file.url}}',
		      type: '{{video.get_playlist_master.encoding_format}}',
		    };
		    player.on('loadedmetadata', function() {
		      console.log('LOADEDMETADATA');
		      var qualityLevels = this.qualityLevels();
		    });
		    //Add source to player
		    player.src(srcOptions);
		    //add quality selector to player
		    player.hlsQualitySelector();
		    player.on("error", function(e){
		      e.stopImmediatePropagation();
		      var error = player.error();
		      if(error.code == 3) {
		        //console.log('error!', error.code, error.type , error.message);
		        if(player.src().indexOf("m3u8")!=-1){
		          //alert("change source to mp4");
		          player.src(mp4_sources);
		          player.controlBar.addChild('QualitySelector');
		          player.play();
		        }
		      }
		    });
		  {% else %}
		    player.src(mp4_sources);
		    player.controlBar.addChild('QualitySelector');
		  {% endif %}
		{% else %}
		  {% if video.get_video_m4a %}
		    var srcOptions = {
		      src: '{{video.get_video_m4a.source_file.url}}',
		      type: '{{video.get_video_m4a.encoding_format}}',
		    };
		    //Add source to player
		    player.src(srcOptions);
		  {% endif %}
		{% endif %}
	  	player.ready(function() {
	  		var tracks = player.textTracks();
	  		var metadataTrack;
	  		for (let i = 0; i < tracks.length; i++) {
	  			var track = tracks[i];
	  			if (track.kind === 'metadata' && track.label === '') {
	  				metadataTrack = track;
	  			}
	  		}
	  		player.on('loadedmetadata', function() {
	  			var slide = [];
	  			for (let i = 0; i < metadataTrack.cues.length; i++) {
			  		data = JSON.parse(metadataTrack.cues[i].text);
			  		slide.push({
			  			title: data.title,
			  			url: data.url,
			  			type: data.type,
			  			start: metadataTrack.cues[i].startTime,
			  			end: metadataTrack.cues[i].endTime
			  		});
			  	}
			  	player.slides(slide);
	  		});
			$('.vjs-big-play-button').css('z-index', 2)
			$('.vjs-control-bar').css('z-index', 3);
		});
		</script>
	{% endif %}
{% endblock more_script %}