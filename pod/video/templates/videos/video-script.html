{% load staticfiles %}
<script>
window.onmessage = function(event) {
   var evt = event || window.event;
   {# maybe use request.get_host to protect it... #}
    if(evt.data.type == 'player:play') {
      player.play();
      evt.source.postMessage({paused: player.paused(), data: {}}, evt.origin);
    }
    if(evt.data.type == 'player:pause') {
      player.pause();
      evt.source.postMessage({paused: player.paused(), data: {}}, evt.origin);
    }
    if(evt.data.type == 'player:mute') {
      player.muted(true);
      evt.source.postMessage({paused: player.muted(), data: {}}, evt.origin);
    }
    if(evt.data.type == 'player:unmute') {
      player.muted(false);
      evt.source.postMessage({paused: player.muted(), data: {}}, evt.origin);
    }
};

var options = {
  notSupportedMessage: "Please use different browser (Mozzila Firefox, Google Chrome, Safari, Microsoft Edge)",
  language: "fr", //en or nl
  {% if request.GET.is_iframe %}
  fluid: false, 
  {% else %}
  fluid: true, 
  {% endif %}
  playbackRates: [0.5, 1, 1.5, 2]
}
var player = videojs('podvideoplayer', options, function(){});

player.on('firstplay', function(){
    var data_form = $( "#video_count_form" ).serializeArray();
    jqxhr = $.post(
      $( "#video_count_form" ).attr("action"),
      data_form
    );
});

{% if video.is_video %}
  /** get all mp4 format **/
  var mp4_sources = {{video.get_video_mp4_json|safe}};
  
  {% if video.get_playlist_master %}
    var srcOptions = {
      src: '{{video.get_playlist_master.source_file.url}}',
      type: '{{video.get_playlist_master.encoding_format}}',
    };
    player.on('loadedmetadata', function() {
      //console.log('LOADEDMETADATA');
      var qualityLevels = this.qualityLevels();
      {% if request.GET.start and request.GET.start != '0' %}
      player.currentTime({{request.GET.start}});
      {%endif%}
    });
    //Add source to player
    player.src(srcOptions);
    //add quality selector to player
    player.hlsQualitySelector();
    player.on("error", function(e){
      e.stopImmediatePropagation();
      var error = player.error();
      //alert(error.code+" "+error.type+" "+error.message);
      if(error.code == 3 || error.code == 4) {
        //console.log('error!', error.code, error.type , error.message);
        if(player.src()=="" || player.src().indexOf("m3u8")!=-1){
          player.src(mp4_sources);
          player.controlBar.addChild('QualitySelector');
          player.play();
        }
      }
    });
  {% else %}
    player.src(mp4_sources);
    player.controlBar.addChild('QualitySelector');
  {% endif %}

  {% if video.overlay_set.all %}
    var list_overlays = [];
    $('ul#overlays li').each(function() {
      list_overlays.push({
        content: $(this).attr('data-content'),
        align: $(this).attr('data-position'),
        showBackground: ($(this).attr('data-background') === 'true'),
        start: parseInt($(this).attr('data-timestart')),
        end: parseInt($(this).attr('data-timeend'))
      });
    });
    if (typeof player.overlay === "function") { 
    player.overlay({
      overlays: list_overlays
    });
    }
  {% endif %}

  {% if video.overview %}
    //add overview
    player.vttThumbnails({
      src: '{% if request.is_secure %}https://{%else%}http://{% endif %}{{request.get_host}}{{video.overview.url}}'
    });
  {%endif%}
  {% if video.is_360 %}
    player.vr({projection: '360'});
  {% endif %}
  //add logo to the player
  {% if request.GET.is_iframe %}
  player.videoJsInfo();
  {%endif%}
  player.videoJsLogo({imgsrc: '{% static LOGO_PLAYER %}', linktitle:'{{TITLE_ETB}} - {{TITLE_SITE}}', link:'{{LINK_PLAYER}}'});
{% else %}
  {% if video.get_video_m4a %}
    var srcOptions = {
      src: '{{video.get_video_m4a.source_file.url}}',
      type: '{{video.get_video_m4a.encoding_format}}',
    };
    //Add source to player
    player.src(srcOptions);
    {% if request.GET.is_iframe %}
    player.videoJsInfo();
    {%endif%}
    //add logo to the player
    player.videoJsLogo({imgsrc: '{% static LOGO_PLAYER %}', linktitle:'{{TITLE_ETB}} - {{TITLE_SITE}}', link:'{{LINK_PLAYER}}'});
    player.on('loadedmetadata', function() {
      {% if request.GET.start and request.GET.start != '0' %}
      player.currentTime({{request.GET.start}});
      {%endif%}
    });
  {% endif %}
{% endif %}
{% if video.chapter_set.all %}
    player.videoJsChapters();
    $('.vjs-big-play-button').css('z-index', 2)
    $('.vjs-control-bar').css('z-index', 3);
  {% endif %}
</script>
