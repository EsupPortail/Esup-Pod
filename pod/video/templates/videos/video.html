{% extends 'base.html' %}
{% load i18n %}
{% load staticfiles %}
{% load tagging_tags %}

{% block page_extra_head %}
<link href="{% static 'video-js-6.8.0/video-js.min.css' %}" rel="stylesheet">
<link href="{% static 'css/quality-selector.css' %}" rel="stylesheet">

<script src="{% static 'video-js-6.8.0/ie8/videojs-ie8.min.js' %}"></script>
<script src="{% static 'video-js-6.8.0/video.min.js' %}"></script>
<script src="{% static 'js/silvermine-videojs-quality-selector.min.js' %}"></script>
<script src="{% static 'js/videojs-http-streaming.min.js' %}"></script>
<script src="{% static 'js/videojs-contrib-quality-levels.min.js' %}"></script>
<script src="{% static 'js/videojs-hls-quality-selector.min.js' %}"></script>
<script src="{% static 'video-js-6.8.0/lang/fr.js' %}"></script>
<script src="{% static 'video-js-6.8.0/lang/nl.js' %}"></script>
{% if video.overlay_set.all %}
  <link href="{% static 'css/videojs-overlay.css' %}" rel="stylesheet">
  <script src="{% static 'js/videojs-overlay.js' %}"></script>
{% endif %}
{% if video.overview %}
<link href="{% static 'css/videojs-vtt-thumbnails.css' %}" rel="stylesheet">
<script src="{% static 'js/videojs-vtt-thumbnails.min.js' %}"></script>
{% endif %}
<style>
.scrollspy-video {
    position: relative;
    height: 200px;
    margin-top: .5rem;
    overflow: auto;
}
{{channel.style}}
{% if channel.color %}
body {
  background-color: {{channel.color}};
}
{%endif%}
</style>
{% endblock page_extra_head %}

{% block breadcrumbs %}{{ block.super }} 
{%if channel %}
{% if theme %}
<li class="breadcrumb-item"><a href="{% url 'channel' slug_c=channel.slug%}">{{channel.title}}</a></li>
{% for t in theme.get_all_parents reversed %}
{% if t is not theme %}
<li class="breadcrumb-item"><a href="{% url 'theme' slug_c=channel.slug slug_t=t.slug%}">{{t.title}}</a></li>
{% endif %}
{% endfor %}
<li class="breadcrumb-item"><a href="{% url 'theme' slug_c=channel.slug slug_t=theme.slug%}">{{theme.title}}</a></li>
<li class="breadcrumb-item active" aria-current="page">{{video.title}}</li>
{% else %}
<li class="breadcrumb-item"><a href="{% url 'channel' slug_c=channel.slug%}">{{channel.title}}</a></li>
<li class="breadcrumb-item active" aria-current="page">{{video.title}}</li>
{% endif %}
{% else %}
<li class="breadcrumb-item"><a href="{% url "videos"%}">{% trans 'Videos' %}</a><li class="breadcrumb-item active" aria-current="page">{{video.title}}</li>
{% endif %}
{% endblock %}

{% block page_title %}{%if channel %}{{channel.title}} - {%endif%}{%if theme %}{{theme.title}} - {%endif%}{{video.title}}{% endblock %}

{% block page_content %}
<meta itemprop="duration" content="{{ video.duration }}" />
<meta itemprop="thumbnailUrl" content="{{ video.thumbnail.url }}" />
<meta itemprop="contentURL" content="{% if request.is_secure %}https{% else %}http{% endif %}://{{ request.META.HTTP_HOST }}{% url 'video' slug=video.slug %}" />
<meta itemprop="embedURL" content="{% if request.is_secure %}https{% else %}http{% endif %}://{{ request.META.HTTP_HOST }}{% url 'video' slug=video.slug %}?is_iframe=true&amp;size=360" />

{%if channel %}
<h3>{{channel.title}}{% if request.user in channel.owners.all %}<span class="float-right"><a href="{% url 'channel_edit' slug=channel.slug %}" title="{% trans "Edit the themes"%}" class="btn btn btn-outline-dark btn-sm"><svg height="32" class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>{% trans "Edit the channel"%}</a></span>{%endif%}</h3>
{% if channel.headband %}
<img src="{{ channel.headband.file.url }}" alt="{% trans 'Headband' %} {{ channel.title }}" class="rounded mx-auto d-block img-fluid img-responsive img-thumbnail" />
{% endif %}
{% if channel.description %}
{{ channel.description|safe }}
{% endif %}
{% if theme %}
<h4>{{theme.title}}</h4>
{% if theme.headband %}
<div align="center" class="channelheader">
    <img src="{{ theme.headband.file.url }}" alt="{% trans 'Headband' %} {{ theme.title }}" class="img-responsive" />
</div>
{% endif %}
{% if theme.description %}
{{ theme.description|safe }}
{% endif %}
{%endif%}
{%endif%}

{% if form %}
<p>{% trans 'This video is protected by password, please fill in and click send.' %}</p>
<form method="post" action="{{ request.get_full_path }}" id="video_password_form" class='needs-validation' novalidate>
    {% csrf_token %}
    <div class="list-group">
    <fieldset>
        <legend>{% trans 'Password required' %}</legend>
        {% if form.errors %}
        <p class="text-danger">{% trans "One or more errors have been found in the form." %}</p>
        {% endif %}
        {% for field_hidden in form.hidden_fields %}
            {{field_hidden}}
            {% endfor %}
            {% for field in form.visible_fields %}
            {% spaceless %}
            <div class="list-group-item">
            <div class="form-group {% if field.field.required %}form-group-required {%endif%}" >
                {{ field.errors }}
                <label for="{{ field.id_for_label }}">{{ field.label }}</label> 
                {{ field }}
                {% if field.help_text %}
                <small id="{{field.id_for_label}}Help" class="form-text text-muted">{{ field.help_text|safe }}</small>
                {% endif %}
                {% if field.field.required %}<div class="invalid-feedback">{% trans "Please provide a valid value for this field" %}.</div>{%endif%}
            </div>
            </div>
            {% endspaceless %}
            {% endfor %}
        <div class="text-center mt-1">
            <button type="submit" class="btn btn-success">{% trans "Send" %}</button>
        </div>
    </fieldset>
    </div>
</form>
<p>
  {% trans 'If you do not have the password for this content, please' %} <a href="{% url 'contact_us' %}?owner={{video.owner.id}}&video={{video.id}}&subject=request_password">{% trans 'contact its owner' %}</a>.
</p>

{% else %}
<video id="podvideoplayer" class="video-js vjs-default-skin vjs-16-9 vjs-big-play-centered" controls preload="auto" height="360"
poster="{{video.get_thumbnail_url}}" data-setup='{}'>
  <p class="vjs-no-js">
    To view this video please enable JavaScript, and consider upgrading to a web browser that
    <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
  </p>
</video>
{% if video.overlay_set.all %}
<ul id="overlays" style="display: none">
  {% for overlay in video.overlay_set.all %}
    <li data-timestart="{{overlay.time_start}}"
        data-timeend="{{overlay.time_end}}"
        data-content="{{overlay.content}}"
        data-position="{{overlay.position}}"
        data-background="{{overlay.background}}">
    </li>
  {% endfor %}
</ul>
{% endif %}
<nav id="navbar-example2" class="navbar navbar-light bg-light">
  <span class="navbar-brand" >{{video.title}} {% if video.date_evt %}<small>[{{ video.date_evt }}]</small>{% endif %}
  <a href="{% url 'contact_us' %}?video={{video.id}}&subject=inappropriate_content" title="{% trans "Report the video"%}" >
    <svg height="32" class="octicon octicon-report" viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M0 2a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v9a1 1 0 0 1-1 1H7l-4 4v-4H1a1 1 0 0 1-1-1V2zm1 0h14v9H6.5L4 13.5V11H1V2zm6 6h2v2H7V8zm0-5h2v4H7V3z"></path></svg></a>
    </span>
  <ul class="nav nav-pills">
    <li class="nav-item">
      <a class="nav-link" href="#summary">{% trans 'Summary' %}</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#infos">{% trans 'Infos' %}</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#downloads">{% trans 'Downloads' %}</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#embed">{% trans 'Embed/Share' %}</a>
    </li>
    {% if video.enrichment_set.all %}
    <li class="nav-item">
      <a class="nav-link" href="#version">{% trans 'Version' %}</a>
    </li>
    {% endif %}
  </ul>
</nav>

<div data-spy="scroll" data-target="#navbar-example2" data-offset="0" class="scrollspy-video">
  <h4 id="summary">{% trans 'Summary' %}</h4>
  <div class="scrollspy-content">
    <p>{{ video.description|safe }}</p>
    {% tags_for_object video as tag_list %}
    {% if tag_list %}
    <p>{% trans 'Tags' %}:&nbsp;
      {% for tag in tag_list %}
       <a href="{% url 'videos' %}?tag={{ tag.slug }}" title="{{ tag }}" {% if request.GET.is_iframe %}target="_blank"{% endif %}>
           <span class="label label-default">{{ tag }}</span>
       </a>
      {% endfor %}
    </p>
    {% endif %}
  </div>
  <h4 id="infos">{% trans 'Infos' %}</h4>
  <div class="scrollspy-content">
    {% trans 'Added by' %}: <a href="{% url 'videos' %}?owner={{ video.owner.username }}" title="{{ video.owner.get_full_name }}" {% if request.GET.is_iframe %}target="_blank"{% endif %}>{{ video.owner.get_full_name }}</a><br/>
    {% trans 'Updated on' %}: <strong>{{ video.date_added }}</strong><br/>
    {% trans 'Duration' %}: <strong>{{ video.duration_in_time }}</strong><br/>
    {% trans 'Number of view(s)' %}: <strong>{{ video.get_viewcount }}</strong><br/>
    {% trans 'Type' %}: <a href="{% url 'videos' %}?type={{ video.type.slug }}" title="{{ video.type.title }}" {% if request.GET.is_iframe %}target="_blank"{% endif %}>{{ video.type.title }}</a>

    {% if video.discipline.all %}<br/>{% trans 'Disciplines' %}:&nbsp;
      {% for disc in video.discipline.all %}
      <a href="{% url 'videos' %}?discipline={{ disc.slug }}" title="{{ disc.title }}" {% if request.GET.is_iframe %}target="_blank"{% endif %}>
          {{ disc.title }}
          
      </a>
      {% endfor %}
    {%endif%}
  </div>
  <h4 id="downloads">{% trans 'Downloads' %}</h4>
  <div class="scrollspy-content">...</div>
  <h4 id="embed">{% trans 'Embed/Share' %}</h4>
  <div class="scrollspy-content">
  {% if not video.is_restricted and not video.password %}
    <p>
        <label>{% trans 'Social Networks' %}</label>
        <a target="_blank" href="http://www.facebook.com/sharer.php?u={{request.build_absolute_uri|urlencode}}" class="btn btn-facebook btn-sm" title="{% trans "Share on" %} Facebook"> <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/F_icon.svg/200px-F_icon.svg" height="24" alt="facebook" /> </a>
        <a target="_blank" href="http://twitter.com/share?url={{request.build_absolute_uri|urlencode}}" class="btn btn-twitter btn-sm" title="{% trans "Share on" %} Twitter"> <img src="https://upload.wikimedia.org/wikipedia/fr/c/c8/Twitter_Bird.svg" height="24" alt="twitter" /> </a>
        <a target="_blank" href="https://plus.google.com/share?url={{request.build_absolute_uri|urlencode}}" class="btn btn-google-plus btn-sm" title="{% trans "Share on" %} Google+"> <img src="https://upload.wikimedia.org/wikipedia/commons/5/5c/Google_plus.svg" height="24" alt="google" /> </a>
    </p>
    <hr />
  {% endif %}
    <p>
      <span class="form-group">
      <label for="txtintegration">{% trans 'Copy the content of this text box and paste it in the page' %}</label>
      <textarea name="txtintegration" id="txtintegration" class="form-control" rows="4">&lt;iframe src="https://{{ request.META.HTTP_HOST }}{% url 'video' slug=video.slug %}?is_iframe=true&amp;size=240" width="640" height="360" style="padding: 0; margin: 0; border:0" allowfullscreen &gt;&lt;/iframe&gt;</textarea>
      </span>
      <span class="form-group">
      <label for="txtpartage">{% trans 'Use this link to share the video' %}</label>
      <input class="form-control" type="text" name="txtpartage" id="txtpartage" value="{% if request.is_secure %}https{% else %}http{% endif %}://{{ request.META.HTTP_HOST }}{% url 'video' slug=video.slug %}" />
      </span>
    </p>
  </div>
  <h4 id="version">{% trans 'Version' %}</h4>
  <div class="scrollspy-content">
    <p>
      {% trans 'Here you will find alternative version of the video if they exist : Enriched, Interactive and Accessible.' %}
    </p>
    {% if video.enrichment_set.all %}
    <small class="video_back">
      <a href="{% url 'video_enriched' slug=video.slug %}">
        <button class="btn btn-default" title="Go to enriched video">{% trans 'Enriched version' %}</button>
      </a>
    </small>
    {% endif %}
    <!-- Interactive -->
    <!-- Accessible -->
  </div>
</div>
{%endif%}
{% endblock page_content %}

{% block page_aside %}


{% if video.owner == request.user or request.user.is_superuser %}
<div class="card card-body">
<h5 class="card-title"><svg height="32" class="octicon octicon-tools" viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M4.48 7.27c.26.26 1.28 1.33 1.28 1.33l.56-.58-.88-.91 1.69-1.8s-.76-.74-.43-.45c.32-1.19.03-2.51-.87-3.44C4.93.5 3.66.2 2.52.51l1.93 2-.51 1.96-1.89.52-1.93-2C-.19 4.17.1 5.48 1 6.4c.94.98 2.29 1.26 3.48.87zm6.44 1.94l-2.33 2.3 3.84 3.98c.31.33.73.49 1.14.49.41 0 .82-.16 1.14-.49.63-.65.63-1.7 0-2.35l-3.79-3.93zM16 2.53L13.55 0 6.33 7.46l.88.91-4.31 4.46-.99.53-1.39 2.27.35.37 2.2-1.44.51-1.02L7.9 9.08l.88.91L16 2.53z"></path></svg>{% trans "Manage video"%}</h5>
      <div class="card-text text-center">
        {% include "videos/link_video.html" %}
      </div>
</div>
{% endif %}
<div class="card card-body">
<h5 class="card-title">
  <svg height="32" class="octicon octicon-pencil" viewBox="0 0 14 16" version="1.1" width="28" aria-hidden="true"><path fill-rule="evenodd" d="M0 11.592v3h3l8-8-3-3-8 8zm3 2H1v-2h1v1h1v1zm10.3-9.3l-1.3 1.3-3-3 1.3-1.3a.996.996 0 0 1 1.41 0l1.59 1.59c.39.39.39 1.02 0 1.41z"></path></svg>
{% trans "take Note"%}
</h5>
<div class="card-text">
  <p>Prenez des notes</p>
  <div id="info"></div>
</div>
</div>
    {% include 'aside.html'%}
{% endblock page_aside %}


{% block more_script %}

{% if form %}
<script>
var showalert = function(message,alerttype) {
    $('body').append('<div id="formalertdiv" class="alert ' +  alerttype + ' alert-dismissible fade show"  role="alert">'+message+'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
    setTimeout(function() { $("#formalertdiv").remove(); }, 5000);
};
// Example starter JavaScript for disabling form submissions if there are invalid fields
(function() {
  'use strict';
  window.addEventListener('load', function() {
    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    var forms = document.getElementsByClassName('needs-validation');
    // Loop over them and prevent submission
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          window.scrollTo($("#video_password_form").scrollTop(), 0); 
          showalert("{% trans "Errors appear in the form, please correct it"%}","alert-danger");
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();
</script>
{% else %}
<script>
var options = {
  notSupportedMessage: "Please use different browser (Mozzila Firefox, Google Chrome, Safari, Microsoft Edge)",
  language: "fr", //en or nl
  fluid: true, 
  playbackRates: [0.5, 1, 1.5, 2]
}
var player = videojs('podvideoplayer', options, function(){});

{% if video.is_video %}
  /** get all mp4 format **/
  var mp4_sources = {{video.get_video_mp4_json|safe}};
  
  {% if video.get_playlist_master %}
    var srcOptions = {
      src: '{{video.get_playlist_master.source_file.url}}',
      type: '{{video.get_playlist_master.encoding_format}}',
    };
    player.on('loadedmetadata', function() {
      //console.log('LOADEDMETADATA');
      var qualityLevels = this.qualityLevels();

    });
    //Add source to player
    player.src(srcOptions);
    //add quality selector to player
    player.hlsQualitySelector();
    player.on("error", function(e){
      e.stopImmediatePropagation();
      var error = player.error();
      if(error.code == 3) {
        //console.log('error!', error.code, error.type , error.message);
        if(player.src().indexOf("m3u8")!=-1){
          //alert("change source to mp4");
          player.src(mp4_sources);
          player.controlBar.addChild('QualitySelector');
          player.play();
        }
      }
    });
  {% else %}
    player.src(mp4_sources);
    player.controlBar.addChild('QualitySelector');
  {% endif %}

  {% if video.overlay_set.all %}
    var list_overlays = [];
    $('ul#overlays li').each(function() {
      list_overlays.push({
        content: $(this).attr('data-content'),
        align: $(this).attr('data-position'),
        showBackground: $(this).attr('data-background'),
        start: parseInt($(this).attr('data-timestart')),
        end: parseInt($(this).attr('data-timeend'))
      });
    });
    player.overlay({
      overlays: list_overlays
    });
  {% endif %}

  {% if video.overview %}
    //add overview
    player.vttThumbnails({
      src: '{% if request.is_secure %}https://{%else%}http://{% endif %}{{request.get_host}}{{video.overview.url}}'
    });
  {%endif%}

{% else %}
  {% if video.get_video_m4a %}
    var srcOptions = {
      src: '{{video.get_video_m4a.source_file.url}}',
      type: '{{video.get_video_m4a.encoding_format}}',
    };
    //Add source to player
    player.src(srcOptions);
  {% endif %}
{% endif %}
</script>
{% endif %}
{% endblock more_script %}